<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_config.title }} - å·²ä¿å­˜SQLé…ç½®</title>
    <style>
        /* å…¨å±€å…¨å±æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f0f2f5;
        }
        .container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }
        /* å¤´éƒ¨ */
        .header {
            background-color: {{ page_config.theme_color }};
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        .header .nav {
            display: flex;
            gap: 24px;
        }
        .header .nav a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .header .nav a:hover {
            opacity: 1;
        }
        /* ä¸»ä½“å†…å®¹ - å…¨å±æ»šåŠ¨ */
        .main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        /* æœç´¢æ  */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }
        .search-bar input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-bar input:focus {
            outline: none;
            border-color: {{ page_config.theme_color }};
            box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.2);
        }
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: {{ page_config.theme_color }};
            color: white;
        }
        .btn-primary:hover {
            background-color: #0d6efd;
        }
        .btn-danger {
            background-color: #f5222d;
            color: white;
        }
        .btn-danger:hover {
            background-color: #d91822;
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid {{ page_config.theme_color }};
            color: {{ page_config.theme_color }};
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        /* è¡¨æ ¼æ ·å¼ */
        .sql-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .sql-table th, .sql-table td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        .sql-table th {
            background-color: #f8f9fa;
            font-weight: 500;
            color: #333;
        }
        .sql-table tr:hover {
            background-color: #fafafa;
        }
        .sql-table .operate {
            display: flex;
            gap: 8px;
        }
        /* ç©ºæ•°æ®æç¤º */
        .empty-tip {
            text-align: center;
            padding: 80px 0;
            color: #666;
            font-size: 14px;
        }
        .empty-tip i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #ddd;
            display: block;
        }
        /* å¼¹çª—æ ·å¼ */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .modal-container {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .modal-close {
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        .modal-close:hover {
            color: #f5222d;
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        /* è¯¦æƒ…æ ·å¼ */
        .detail-item {
            margin-bottom: 16px;
        }
        .detail-item label {
            display: block;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .detail-item .value {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            word-break: break-all;
        }
        .sql-content {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 14px;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #e8e8e8;
        }
        /* ç»“æœå±•ç¤ºåŒº */
        .result-section {
            margin-top: 24px;
            border-top: 1px solid #e8e8e8;
            padding-top: 24px;
        }
        .result-style {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .result-style select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
        }
        /* ç»“æœå­æ ·å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .result-table th, .result-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        .result-table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        .json-view {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 16px;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #e8e8e8;
            margin-top: 16px;
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }
        .card .card-field {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .card .card-field label {
            font-weight: 500;
            color: #666;
            margin-right: 8px;
        }
        /* åŠ è½½/æç¤º */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 14px;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            font-size: 14px;
        }
        .alert-success {
            background-color: #f0f9ff;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .alert-error {
            background-color: #fff2f0;
            color: #f5222d;
            border: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>å·²ä¿å­˜SQLé…ç½®ç®¡ç†</h1>
            <div class="nav">
                <a href="/">è¿”å›å¯è§†åŒ–SQLç”Ÿæˆ</a>
                <a href="/api/init_web_db" onclick="return confirm('ç¡®å®šè¦åˆå§‹åŒ–æ•°æ®åº“å—ï¼Ÿ')">åˆå§‹åŒ–æ•°æ®åº“</a>
            </div>
        </div>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="main">
            <!-- æœç´¢æ  -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="è¾“å…¥é…ç½®åç§°/åº“å/è¡¨åæœç´¢...">
                <button class="btn btn-outline" onclick="searchSql()">æœç´¢</button>
                <button class="btn btn-primary" onclick="refreshList()">åˆ·æ–°åˆ—è¡¨</button>
            </div>

            <!-- æç¤ºæ¡† -->
            <div id="alertBox" class="alert" style="display: none;"></div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">åŠ è½½ä¸­...</div>

            <!-- SQLé…ç½®è¡¨æ ¼ -->
            <table class="sql-table" id="sqlTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>é…ç½®åç§°</th>
                        <th>æ•°æ®åº“è¿æ¥</th>
                        <th>åº“å</th>
                        <th>è¡¨å</th>
                        <th>æ“ä½œç±»å‹</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="sqlTableBody"></tbody>
            </table>

            <!-- ç©ºæ•°æ®æç¤º -->
            <div id="emptyTip" class="empty-tip" style="display: none;">
                <i>ğŸ“„</i>
                <div>æš‚æ— ä¿å­˜çš„SQLé…ç½®ï¼Œå‰å¾€å¯è§†åŒ–SQLç”Ÿæˆé¡µé¢åˆ›å»ºå¹¶ä¿å­˜</div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…/æ‰§è¡Œå¼¹çª— -->
    <div class="modal-mask" id="detailModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>SQLé…ç½®è¯¦æƒ… & æ‰§è¡Œ</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- é…ç½®è¯¦æƒ… -->
                <div class="detail-item">
                    <label>é…ç½®åç§°</label>
                    <div class="value" id="detailConfigName"></div>
                </div>
                <div class="detail-item" style="display: flex; gap: 16px;">
                    <div style="flex: 1;">
                        <label>æ•°æ®åº“è¿æ¥</label>
                        <div class="value" id="detailDbAlias"></div>
                    </div>
                    <div style="flex: 1;">
                        <label>æ“ä½œç±»å‹</label>
                        <div class="value" id="detailOperationType"></div>
                    </div>
                </div>
                <div class="detail-item" style="display: flex; gap: 16px;">
                    <div style="flex: 1;">
                        <label>åº“å</label>
                        <div class="value" id="detailDbName"></div>
                    </div>
                    <div style="flex: 1;">
                        <label>è¡¨å</label>
                        <div class="value" id="detailTableName"></div>
                    </div>
                </div>
                <div class="detail-item">
                    <label>åˆ›å»ºæ—¶é—´</label>
                    <div class="value" id="detailCreateTime"></div>
                </div>
                <div class="detail-item">
                    <label>å¤‡æ³¨</label>
                    <div class="value" id="detailRemark" style="min-height: 40px;"></div>
                </div>
                <div class="detail-item">
                    <label>SQLè¯­å¥</label>
                    <div class="sql-content" id="detailSqlText"></div>
                </div>

                <!-- æ‰§è¡ŒåŒºåŸŸ -->
                <div class="result-section">
                    <div class="result-style">
                        <label>æ‰§è¡Œç»“æœå±•ç¤ºæ ·å¼ï¼š</label>
                        <select id="resultStyleSelect">
                            <option value="è¡¨æ ¼">è¡¨æ ¼</option>
                            <option value="JSON">JSON</option>
                            <option value="å¡ç‰‡å¼">å¡ç‰‡å¼</option>
                            <option value="CSVä¸‹è½½">CSVä¸‹è½½</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="executeSavedSql()">æ‰§è¡Œæ­¤SQL</button>
                    </div>

                    <!-- æ‰§è¡Œæç¤º -->
                    <div id="executeAlert" class="alert" style="display: none;"></div>
                    <!-- æ‰§è¡ŒåŠ è½½ -->
                    <div id="executeLoading" class="loading" style="display: none;">æ‰§è¡Œä¸­...</div>
                    <!-- ç»“æœå®¹å™¨ -->
                    <div id="resultContainer" style="min-height: 100px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentSqlId = 0;
        let sqlList = [];

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            refreshList();
            // å›è½¦æœç´¢
            document.getElementById('searchInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') searchSql();
            });
        };

        // åŠ è½½/åˆ·æ–°SQLåˆ—è¡¨
        function refreshList() {
            showLoading(true);
            fetch('/api/get_saved_sql')
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.code === 200 && data.data && data.data.length > 0) {
                    sqlList = data.data;
                    renderSqlTable(data.data);
                } else {
                    showEmptyTip(true);
                    showAlert('æš‚æ— ä¿å­˜çš„SQLé…ç½®', 'info');
                }
            })
            .catch(err => {
                showLoading(false);
                showEmptyTip(true);
                showAlert('åŠ è½½åˆ—è¡¨å¤±è´¥ï¼š' + err.message, 'error');
            });
        }

        // æ¸²æŸ“SQLè¡¨æ ¼
        function renderSqlTable(list) {
            const tableBody = document.getElementById('sqlTableBody');
            tableBody.innerHTML = '';
            showEmptyTip(false);
            document.getElementById('sqlTable').style.display = 'table';

            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.config_name}</td>
                    <td>${item.db_alias}</td>
                    <td>${item.db_name || 'æœªæŒ‡å®š'}</td>
                    <td>${item.table_name || 'æœªæŒ‡å®š'}</td>
                    <td>${item.operation_type}</td>
                    <td>${item.create_time}</td>
                    <td class="operate">
                        <button class="btn btn-primary btn-sm" onclick="showDetail(${item.id})">æŸ¥çœ‹/æ‰§è¡Œ</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSql(${item.id})">åˆ é™¤</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // æœç´¢SQL
        function searchSql() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!keyword) {
                renderSqlTable(sqlList);
                showAlert('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'info');
                return;
            }
            const filterList = sqlList.filter(item =>
                item.config_name.toLowerCase().includes(keyword) ||
                (item.db_name && item.db_name.toLowerCase().includes(keyword)) ||
                (item.table_name && item.table_name.toLowerCase().includes(keyword))
            );
            if (filterList.length > 0) {
                renderSqlTable(filterList);
            } else {
                showEmptyTip(true);
                showAlert('æœªæ‰¾åˆ°åŒ¹é…çš„SQLé…ç½®', 'info');
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function showDetail(sqlId) {
            currentSqlId = sqlId;
            fetch(`/api/get_sql_detail/${sqlId}`)
            .then(res => res.json())
            .then(data => {
                if (data.code === 200 && data.data) {
                    const detail = data.data;
                    document.getElementById('detailConfigName').innerText = detail.config_name || '';
                    document.getElementById('detailDbAlias').innerText = detail.db_alias || '';
                    document.getElementById('detailOperationType').innerText = detail.operation_type || '';
                    document.getElementById('detailDbName').innerText = detail.db_name || 'æœªæŒ‡å®š';
                    document.getElementById('detailTableName').innerText = detail.table_name || 'æœªæŒ‡å®š';
                    document.getElementById('detailCreateTime').innerText = detail.create_time || '';
                    document.getElementById('detailRemark').innerText = detail.remark || 'æ— ';
                    document.getElementById('detailSqlText').innerText = detail.sql_text || '';
                    // é‡ç½®æ‰§è¡ŒåŒºåŸŸ
                    document.getElementById('executeAlert').style.display = 'none';
                    document.getElementById('resultContainer').innerHTML = '';
                    // æ˜¾ç¤ºå¼¹çª—
                    document.getElementById('detailModal').style.display = 'flex';
                } else {
                    showAlert('è·å–è¯¦æƒ…å¤±è´¥ï¼š' + data.msg, 'error');
                }
            })
            .catch(err => {
                showAlert('è·å–è¯¦æƒ…å¼‚å¸¸ï¼š' + err.message, 'error');
            });
        }

        // æ‰§è¡Œå·²ä¿å­˜çš„SQL
        function executeSavedSql() {
            const resultStyle = document.getElementById('resultStyleSelect').value;
            document.getElementById('executeLoading').style.display = 'block';
            document.getElementById('executeAlert').style.display = 'none';
            document.getElementById('resultContainer').innerHTML = '';

            fetch(`/api/execute_saved_sql/${currentSqlId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ result_style: resultStyle })
            })
            .then(res => {
                // CSVä¸‹è½½ç‰¹æ®Šå¤„ç†
                if (resultStyle === 'CSVä¸‹è½½') {
                    if (res.ok) {
                        res.blob().then(blob => {
                            const a = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            a.href = url;
                            a.download = `saved_sql_result_${currentSqlId}.csv`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showExecuteAlert('CSVæ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
                        });
                    } else {
                        showExecuteAlert('CSVä¸‹è½½å¤±è´¥', 'error');
                    }
                    return null;
                }
                return res.json();
            })
            .then(data => {
                document.getElementById('executeLoading').style.display = 'none';
                if (!data) return;
                if (data.code === 200 && data.data) {
                    showExecuteAlert('SQLæ‰§è¡ŒæˆåŠŸ', 'success');
                    renderResult(data.data.fields, data.data.result, data.data.style);
                } else {
                    showExecuteAlert('SQLæ‰§è¡Œå¤±è´¥ï¼š' + data.msg, 'error');
                }
            })
            .catch(err => {
                document.getElementById('executeLoading').style.display = 'none';
                showExecuteAlert('SQLæ‰§è¡Œå¼‚å¸¸ï¼š' + err.message, 'error');
            });
        }

        // æ¸²æŸ“æ‰§è¡Œç»“æœï¼ˆå¤šæ ·å¼ï¼‰
        function renderResult(fields, result, style) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '';

            if (style === 'è¡¨æ ¼') {
                if (!result || result.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æ— æ‰§è¡Œç»“æœ</div>';
                    return;
                }
                let tableHtml = `<table class="result-table"><thead><tr>`;
                fields.forEach(f => tableHtml += `<th>${f}</th>`);
                tableHtml += `</tr></thead><tbody>`;
                result.forEach(row => {
                    tableHtml += `<tr>`;
                    fields.forEach(f => tableHtml += `<td>${row[f] ?? ''}</td>`);
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            } else if (style === 'JSON') {
                container.innerHTML = `<div class="json-view">${result}</div>`;
            } else if (style === 'å¡ç‰‡å¼') {
                if (!result || result.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æ— æ‰§è¡Œç»“æœ</div>';
                    return;
                }
                let cardHtml = `<div class="card-container">`;
                result.forEach(row => {
                    cardHtml += `<div class="card">`;
                    fields.forEach(f => cardHtml += `<div class="card-field"><label>${f}ï¼š</label>${row[f] ?? ''}</div>`);
                    cardHtml += `</div>`;
                });
                cardHtml += `</div>`;
                container.innerHTML = cardHtml;
            }
        }

        // åˆ é™¤SQLé…ç½®
        function deleteSql(sqlId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥SQLé…ç½®å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) return;
            fetch(`/api/delete_sql/${sqlId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    showAlert('åˆ é™¤æˆåŠŸ', 'success');
                    refreshList();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥ï¼š' + data.msg, 'error');
                }
            })
            .catch(err => {
                showAlert('åˆ é™¤å¼‚å¸¸ï¼š' + err.message, 'error');
            });
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentSqlId = 0;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºç©ºæ•°æ®æç¤º
        function showEmptyTip(show) {
            document.getElementById('emptyTip').style.display = show ? 'block' : 'none';
            document.getElementById('sqlTable').style.display = show ? 'none' : 'table';
        }

        // æ˜¾ç¤ºå…¨å±€æç¤º
        function showAlert(msg, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.style.display = 'block';
            alertBox.className = 'alert';
            if (type === 'success') alertBox.classList.add('alert-success');
            else if (type === 'error') alertBox.classList.add('alert-error');
            alertBox.innerText = msg;
            setTimeout(() => alertBox.style.display = 'none', 3000);
        }

        // æ˜¾ç¤ºæ‰§è¡ŒåŒºåŸŸæç¤º
        function showExecuteAlert(msg, type = 'info') {
            const alertBox = document.getElementById('executeAlert');
            alertBox.style.display = 'block';
            alertBox.className = 'alert';
            if (type === 'success') alertBox.classList.add('alert-success');
            else if (type === 'error') alertBox.classList.add('alert-error');
            alertBox.innerText = msg;
            setTimeout(() => alertBox.style.display = 'none', 3000);
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(e) {
            const modal = document.getElementById('detailModal');
            if (e.target === modal) closeModal();
        };
    </script>
</body>
</html>